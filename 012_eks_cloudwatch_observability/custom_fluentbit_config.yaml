Transform: AWS::LanguageExtensions
Parameters:
  AmazonLinux2023AmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64
Mappings: 
  AzMapping: 
    a:
      PublicSubnetCidr: 10.0.0.0/24
      PrivateSubnetCidr: 10.0.1.0/24
    b: 
      PublicSubnetCidr: 10.0.2.0/24
      PrivateSubnetCidr: 10.0.3.0/24
    c: 
      PublicSubnetCidr: 10.0.4.0/24
      PrivateSubnetCidr: 10.0.5.0/24
Resources:
  Vpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: True
      EnableDnsHostnames: True
      Tags:
        - Key: Name
          Value: vpc
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: igw
  VpcInternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref Vpc
  PublicSubnetRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      Tags:
        - Key: Name
          Value: public-rt
      VpcId: !Ref Vpc
  PublicSubnetRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
      RouteTableId: !Ref PublicSubnetRouteTable
  
  # PublicSubnets
  Fn::ForEach::PublicSubnets:
    - Az
    - [a, b]
    - PublicSubnet${Az}:
        Type: AWS::EC2::Subnet
        Properties:
          AvailabilityZone: !Sub ${AWS::Region}${Az}
          CidrBlock: !FindInMap [AzMapping, !Ref Az, PublicSubnetCidr]
          MapPublicIpOnLaunch: true
          Tags:
            - Key: Name
              Value: !Sub public-subnet-${Az}
          VpcId: !Ref Vpc
      PublicSubnet${Az}RouteTableAssociation:
        Type: AWS::EC2::SubnetRouteTableAssociation
        Properties:
          RouteTableId: !Ref PublicSubnetRouteTable
          SubnetId:
            Ref: !Sub PublicSubnet${Az}
  
  # PrivateSubnets
  Fn::ForEach::PrivateSubnets:
    - Az
    - [a, b]
    - PrivateSubnet${Az}:
        Type: AWS::EC2::Subnet
        Properties:
          VpcId: !Ref Vpc
          CidrBlock: !FindInMap [AzMapping, !Ref Az, PrivateSubnetCidr]
          AvailabilityZone: !Sub ${AWS::Region}${Az}
          Tags:
            - Key: Name
              Value: !Sub private-subnet-${Az}
      PrivateSubnet${Az}RouteTable:
        Type: AWS::EC2::RouteTable
        Properties:
          VpcId: !Ref Vpc
          Tags:
            - Key: Name
              Value: !Sub private-rt-${Az}
      Natgateway${Az}ElasticIp:
        Type: AWS::EC2::EIP
      NatGateway${Az}:
        Type: AWS::EC2::NatGateway
        Properties:
          AllocationId: !GetAtt
            - !Sub Natgateway${Az}ElasticIp
            - AllocationId
          SubnetId:
            Ref: !Sub PublicSubnet${Az}
          Tags: 
            - Key : Name
              Value : !Sub natgw-${Az}
      PrivateSubnet${Az}RouteTableAssociation:
        Type: AWS::EC2::SubnetRouteTableAssociation
        Properties:
          RouteTableId:
            Ref: !Sub PrivateSubnet${Az}RouteTable
          SubnetId: 
            Ref: !Sub PrivateSubnet${Az}
      PrivateSubnet${Az}Route:
        Type: AWS::EC2::Route
        Properties:
          DestinationCidrBlock: 0.0.0.0/0
          NatGatewayId:
            Ref: !Sub NatGateway${Az}
          RouteTableId:
            Ref: !Sub PrivateSubnet${Az}RouteTable

  BastionEc2:
    Type: AWS::EC2::Instance
    CreationPolicy:
      ResourceSignal:
        Count: '1'        
        Timeout: PT30M
    Properties:
      InstanceType: t3.medium
      KeyName: !Ref KeyPair
      ImageId: !Ref AmazonLinux2023AmiId
      NetworkInterfaces: 
        - AssociatePublicIpAddress: True
          DeviceIndex: 0
          SubnetId: !Ref PublicSubneta
          GroupSet: 
            - !Ref BastionEc2SecurityGroup
            - !GetAtt EksCluster.ClusterSecurityGroupId
      IamInstanceProfile: !Ref BastionEc2InstanceProfile
      Tags: [{ Key: Name, Value: wsc2025-cicd-bastion }]
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          dnf update -yq
          dnf groupinstall -yq "Development Tools"
          dnf install -yq python3.13
          ln -sf /usr/bin/python3.13 /usr/bin/python
          python -m ensurepip --upgrade

          export VSC_VERSION="4.102.3"
          wget https://github.com/coder/code-server/releases/download/v$VSC_VERSION/code-server-$VSC_VERSION-linux-amd64.tar.gz
          tar -xzf code-server-$VSC_VERSION-linux-amd64.tar.gz
          mv code-server-$VSC_VERSION-linux-amd64 /usr/local/lib/code-server
          ln -s /usr/local/lib/code-server/bin/code-server /usr/local/bin/code-server

          mkdir -p /home/ec2-user/.config/code-server
          cat <<EOF > /home/ec2-user/.config/code-server/config.yaml
          bind-addr: 0.0.0.0:8000
          auth: none
          cert: false
          EOF
          chown -R ec2-user:ec2-user /home/ec2-user/.config
          
          cat <<EOF > /etc/systemd/system/code-server.service
          [Unit]
          Description=VS Code Server
          After=network.target
          [Service]
          Type=simple
          User=ec2-user
          ExecStart=/usr/local/bin/code-server --config /home/ec2-user/.config/code-server/config.yaml /home/ec2-user
          Restart=always
          [Install]
          WantedBy=multi-user.target
          EOF
          systemctl daemon-reload
          systemctl enable code-server
          systemctl start code-server

          sudo -Eu ec2-user bash << 'EOF'
          cd /home/ec2-user
          mkdir -p /home/ec2-user/bin
          curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/1.33.0/2025-05-01/bin/linux/amd64/kubectl
          chmod +x kubectl
          mv kubectl /home/ec2-user/bin/kubectl
          export PATH=/home/ec2-user/bin:$PATH
          echo "export PATH=/home/ec2-user/bin:$PATH" >> ~/.bashrc
          echo "alias k=kubectl" >> ~/.bashrc
          echo "complete -o default -F __start_kubectl k" >> ~/.bashrc
          echo "source <(kubectl completion bash)" >> ~/.bashrc
          
          aws eks update-kubeconfig --region ${AWS::Region} --name ${EksCluster}

          curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
          sudo mv /tmp/eksctl /usr/local/bin

          curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 > /home/ec2-user/get_helm.sh
          chmod 700 /home/ec2-user/get_helm.sh
          /home/ec2-user/get_helm.sh

          /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource BastionEc2 --region ${AWS::Region}
  BastionEc2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Security Group for Bastion EC2 SSH Connection"
      GroupName: bastion-sg
      SecurityGroupIngress: 
        - CidrIp: 0.0.0.0/0
          FromPort: 22
          IpProtocol: tcp
          ToPort: 22
        - CidrIp: 0.0.0.0/0
          FromPort: 8000
          IpProtocol: tcp
          ToPort: 8000
      VpcId: !Ref Vpc
  BastionEc2IamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AdministratorAccess
  BastionEc2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles: [!Ref BastionEc2IamRole]
  KeyPair:
    Type: AWS::EC2::KeyPair
    Properties:
      KeyName: !Sub
        - "key-${Id}"
        - Id: !Select [3, !Split ['-', !Select [2, !Split ['/', !Ref AWS::StackId]]]]

  EksCluster:
    Type: AWS::EKS::Cluster
    Properties:
      Version: "1.33"
      AccessConfig: 
        AuthenticationMode: API_AND_CONFIG_MAP
        BootstrapClusterCreatorAdminPermissions: True
      Logging: 
        ClusterLogging:
          EnabledTypes:
            - Type: api
            - Type: audit
            - Type: authenticator
            - Type: controllerManager
            - Type: scheduler
      ResourcesVpcConfig: 
        EndpointPrivateAccess: True
        EndpointPublicAccess: True
        SubnetIds: 
          - !Ref PublicSubneta
          - !Ref PublicSubnetb
          - !Ref PrivateSubneta
          - !Ref PrivateSubnetb
      RoleArn: !GetAtt EksClusterIamRole.Arn
      UpgradePolicy: 
        SupportType: STANDARD
      BootstrapSelfManagedAddons: False
  EksClusterIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: eks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns: 
        - arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
  BastionEc2IamAccessEntry:
    Type: AWS::EKS::AccessEntry
    Properties:
      ClusterName: !Ref EksCluster
      PrincipalArn: !GetAtt BastionEc2IamRole.Arn
      Type: STANDARD
      AccessPolicies: 
        - PolicyArn: arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy
          AccessScope:
            Type: cluster
  VpcCniAddon:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: vpc-cni
      ClusterName: !Ref EksCluster
      ResolveConflicts: OVERWRITE
  KubeProxyAddon:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: kube-proxy
      ClusterName: !Ref EksCluster
      ResolveConflicts: OVERWRITE
  CorednsAddon:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: coredns
      ClusterName: !Ref EksCluster
      ResolveConflicts: OVERWRITE
  MetricsServerAddon:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: metrics-server
      ClusterName: !Ref EksCluster
      ResolveConflicts: OVERWRITE
  PodIdentityAgentAddon:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: eks-pod-identity-agent
      ClusterName: !Ref EksCluster
      ResolveConflicts: OVERWRITE
  ManagedNodeGroup:
    Type: AWS::EKS::Nodegroup
    Properties:
      ClusterName: !Ref EksCluster
      AmiType: AL2023_x86_64_STANDARD
      InstanceTypes: 
        - t3.medium
      CapacityType: ON_DEMAND # SPOT | CAPACITY_BLOCK
      NodeRole: !GetAtt EksNodeIamRole.Arn
      ScalingConfig: 
        MinSize: 2
        DesiredSize: 2
        MaxSize: 2
      Subnets: 
        - !Ref PrivateSubneta
        - !Ref PrivateSubnetb
      LaunchTemplate:
        Id: !Ref
          Fn::Sub: LaunchTemplate
      NodeRepairConfig: 
        Enabled: True
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData: 
        KeyName: !Ref KeyPair
        SecurityGroupIds: 
          - !GetAtt EksCluster.ClusterSecurityGroupId
        TagSpecifications: 
          - ResourceType: instance
            Tags: 
              - Key: Name
                Value: !Sub eks-node
  EksNodeIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
  
  CloudWatchObservabilityAddon:
    Type: AWS::EKS::Addon
    DependsOn:
      - PodIdentityAgentAddon
    Properties:
      AddonName: amazon-cloudwatch-observability
      ClusterName: !Ref EksCluster
      ResolveConflicts: OVERWRITE
      PodIdentityAssociations:
        - RoleArn: !GetAtt CloudWatchObservabilityIamRole.Arn
          ServiceAccount: cloudwatch-agent
      ConfigurationValues: |
        containerLogs:
          fluentBit:
            config:
              extraFiles:
                application-log.conf: ""
                dataplane-log.conf: ""
                vpc-cni.conf: |
                  [INPUT]
                    Name                tail
                    Tag                 vpc-cni.*
                    Path                /var/log/containers/aws-node-*_kube-system_*.log
                    multiline.parser    docker, cri
                    DB                  /var/fluent-bit/state/flb-vpc-cni.db
                    Mem_Buf_Limit       50MB
                    Skip_Long_Lines     On
                    Refresh_Interval    10
                    Rotate_Wait         30
                    storage.type        filesystem
                    Read_from_Head      ${READ_FROM_HEAD}

                  [FILTER]
                    Name                kubernetes
                    Match               vpc-cni.*
                    Kube_Tag_Prefix     vpc-cni.var.log.containers.
                    Kube_URL            https://kubernetes.default.svc:443
                    Merge_Log           On
                    Merge_Log_Key       log_processed
                    K8S-Logging.Parser  On
                    K8S-Logging.Exclude Off
                    Labels              Off
                    Annotations         Off
                    Use_Kubelet         On
                    Kubelet_Port        10250
                    Buffer_Size         0
                    Use_Pod_Association On
                  
                  [FILTER]
                    Name                nest
                    Match               vpc-cni.*
                    Operation           lift
                    Nested_under        kubernetes
                  
                  [FILTER]
                    Name                modify
                    Match               vpc-cni.*
                    Rename              pod_name pod
                    Rename              container_name container
                    Rename              namespace_name namespace
                    Rename              host node
                  
                  [FILTER]
                    Name                record_modifier
                    Match               vpc-cni.*
                    Allowlist_key       log
                    Allowlist_key       pod
                    Allowlist_key       container
                    Allowlist_key       namespace
                    Allowlist_key       node

                  [OUTPUT]
                    Name                cloudwatch_logs
                    Match               vpc-cni.*
                    region              ${AWS_REGION}
                    log_group_name      /aws/eks/${CLUSTER_NAME}/vpc-cni
                    log_stream_prefix   vpc-cni-
                    log_stream_template $pod.FROM.${HOST_NAME}
                    auto_create_group   true
                    extra_user_agent    container-insights
                    add_entity          true
                kube-proxy.conf: |
                  [INPUT]
                    Name                tail
                    Tag                 kube-proxy.*
                    Path                /var/log/containers/kube-proxy-*_kube-system_*.log
                    multiline.parser    docker, cri
                    DB                  /var/fluent-bit/state/flb-kube-proxy.db
                    Mem_Buf_Limit       50MB
                    Skip_Long_Lines     On
                    Refresh_Interval    10
                    Rotate_Wait         30
                    storage.type        filesystem
                    Read_from_Head      ${READ_FROM_HEAD}

                  [FILTER]
                    Name                kubernetes
                    Match               kube-proxy.*
                    Kube_Tag_Prefix     kube-proxy.var.log.containers.
                    Kube_URL            https://kubernetes.default.svc:443
                    Merge_Log           On
                    Merge_Log_Key       log_processed
                    K8S-Logging.Parser  On
                    K8S-Logging.Exclude Off
                    Labels              Off
                    Annotations         Off
                    Use_Kubelet         On
                    Kubelet_Port        10250
                    Buffer_Size         0
                    Use_Pod_Association On
                  
                  [FILTER]
                    Name                nest
                    Match               kube-proxy.*
                    Operation           lift
                    Nested_under        kubernetes
                  
                  [FILTER]
                    Name                modify
                    Match               kube-proxy.*
                    Rename              pod_name pod
                    Rename              container_name container
                    Rename              namespace_name namespace
                    Rename              host node
                  
                  [FILTER]
                    Name                record_modifier
                    Match               kube-proxy.*
                    Allowlist_key       log
                    Allowlist_key       pod
                    Allowlist_key       container
                    Allowlist_key       namespace
                    Allowlist_key       node

                  [OUTPUT]
                    Name                cloudwatch_logs
                    Match               kube-proxy.*
                    region              ${AWS_REGION}
                    log_group_name      /aws/eks/${CLUSTER_NAME}/kube-proxy
                    log_stream_prefix   kube-proxy-
                    log_stream_template $pod.FROM.${HOST_NAME}
                    auto_create_group   true
                    extra_user_agent    container-insights
                    add_entity          true
                coredns.conf: |
                  [INPUT]
                    Name                tail
                    Tag                 coredns.*
                    Path                /var/log/containers/coredns-*_kube-system_*.log
                    multiline.parser    docker, cri
                    DB                  /var/fluent-bit/state/flb-coredns.db
                    Mem_Buf_Limit       50MB
                    Skip_Long_Lines     On
                    Refresh_Interval    10
                    Rotate_Wait         30
                    storage.type        filesystem
                    Read_from_Head      ${READ_FROM_HEAD}

                  [FILTER]
                    Name                kubernetes
                    Match               coredns.*
                    Kube_Tag_Prefix     coredns.var.log.containers.
                    Kube_URL            https://kubernetes.default.svc:443
                    Merge_Log           On
                    Merge_Log_Key       log_processed
                    K8S-Logging.Parser  On
                    K8S-Logging.Exclude Off
                    Labels              Off
                    Annotations         Off
                    Use_Kubelet         On
                    Kubelet_Port        10250
                    Buffer_Size         0
                    Use_Pod_Association On
                  
                  [FILTER]
                    Name                nest
                    Match               coredns.*
                    Operation           lift
                    Nested_under        kubernetes
                  
                  [FILTER]
                    Name                modify
                    Match               coredns.*
                    Rename              pod_name pod
                    Rename              container_name container
                    Rename              namespace_name namespace
                    Rename              host node
                  
                  [FILTER]
                    Name                record_modifier
                    Match               coredns.*
                    Allowlist_key       log
                    Allowlist_key       pod
                    Allowlist_key       container
                    Allowlist_key       namespace
                    Allowlist_key       node

                  [OUTPUT]
                    Name                cloudwatch_logs
                    Match               coredns.*
                    region              ${AWS_REGION}
                    log_group_name      /aws/eks/${CLUSTER_NAME}/coredns
                    log_stream_prefix   coredns-
                    log_stream_template $pod.FROM.${HOST_NAME}
                    auto_create_group   true
                    extra_user_agent    container-insights
                    add_entity          true
                metrics-server.conf: |
                  [INPUT]
                    Name                tail
                    Tag                 metrics-server.*
                    Path                /var/log/containers/metrics-server-*_kube-system_*.log
                    multiline.parser    docker, cri
                    DB                  /var/fluent-bit/state/flb-metrics-server.db
                    Mem_Buf_Limit       50MB
                    Skip_Long_Lines     On
                    Refresh_Interval    10
                    Rotate_Wait         30
                    storage.type        filesystem
                    Read_from_Head      ${READ_FROM_HEAD}

                  [FILTER]
                    Name                kubernetes
                    Match               metrics-server.*
                    Kube_Tag_Prefix     metrics-server.var.log.containers.
                    Kube_URL            https://kubernetes.default.svc:443
                    Merge_Log           On
                    Merge_Log_Key       log_processed
                    K8S-Logging.Parser  On
                    K8S-Logging.Exclude Off
                    Labels              Off
                    Annotations         Off
                    Use_Kubelet         On
                    Kubelet_Port        10250
                    Buffer_Size         0
                    Use_Pod_Association On
                  
                  [FILTER]
                    Name                nest
                    Match               metrics-server.*
                    Operation           lift
                    Nested_under        kubernetes
                  
                  [FILTER]
                    Name                modify
                    Match               metrics-server.*
                    Rename              pod_name pod
                    Rename              container_name container
                    Rename              namespace_name namespace
                    Rename              host node
                  
                  [FILTER]
                    Name                record_modifier
                    Match               metrics-server.*
                    Allowlist_key       log
                    Allowlist_key       pod
                    Allowlist_key       container
                    Allowlist_key       namespace
                    Allowlist_key       node

                  [OUTPUT]
                    Name                cloudwatch_logs
                    Match               metrics-server.*
                    region              ${AWS_REGION}
                    log_group_name      /aws/eks/${CLUSTER_NAME}/metrics-server
                    log_stream_prefix   metrics-server-
                    log_stream_template $pod.FROM.${HOST_NAME}
                    auto_create_group   true
                    extra_user_agent    container-insights
                    add_entity          true
                amazon-cloudwatch-observability.conf: |
                  [INPUT]
                    Name                tail
                    Tag                 amazon-cloudwatch-observability.*
                    Path                /var/log/containers/amazon-cloudwatch-observability-controller-manager-*_amazon-cloudwatch_*.log, /var/log/containers/cloudwatch-agent-*_amazon-cloudwatch_*.log, /var/log/containers/fluent-bit-*_amazon-cloudwatch_*.log
                    multiline.parser    docker, cri
                    DB                  /var/fluent-bit/state/flb-amazon-cloudwatch-observability.db
                    Mem_Buf_Limit       50MB
                    Skip_Long_Lines     On
                    Refresh_Interval    10
                    Rotate_Wait         30
                    storage.type        filesystem
                    Read_from_Head      ${READ_FROM_HEAD}

                  [FILTER]
                    Name                kubernetes
                    Match               amazon-cloudwatch-observability.*
                    Kube_Tag_Prefix     amazon-cloudwatch-observability.var.log.containers.
                    Kube_URL            https://kubernetes.default.svc:443
                    Merge_Log           On
                    Merge_Log_Key       log_processed
                    K8S-Logging.Parser  On
                    K8S-Logging.Exclude Off
                    Labels              Off
                    Annotations         Off
                    Use_Kubelet         On
                    Kubelet_Port        10250
                    Buffer_Size         0
                    Use_Pod_Association On
                  
                  [FILTER]
                    Name                nest
                    Match               amazon-cloudwatch-observability.*
                    Operation           lift
                    Nested_under        kubernetes
                  
                  [FILTER]
                    Name                modify
                    Match               amazon-cloudwatch-observability.*
                    Rename              pod_name pod
                    Rename              container_name container
                    Rename              namespace_name namespace
                    Rename              host node
                  
                  [FILTER]
                    Name                record_modifier
                    Match               amazon-cloudwatch-observability.*
                    Allowlist_key       log
                    Allowlist_key       pod
                    Allowlist_key       container
                    Allowlist_key       namespace
                    Allowlist_key       node

                  [OUTPUT]
                    Name                cloudwatch_logs
                    Match               amazon-cloudwatch-observability.*
                    region              ${AWS_REGION}
                    log_group_name      /aws/eks/${CLUSTER_NAME}/amazon-cloudwatch-observability
                    log_stream_prefix   amazon-cloudwatch-observability-
                    log_stream_template $pod.FROM.${HOST_NAME}
                    auto_create_group   true
                    extra_user_agent    container-insights
                    add_entity          true
                aws-efs-csi-driver.conf: |
                  [INPUT]
                    Name                tail
                    Tag                 aws-efs-csi-driver.*
                    Path                /var/log/containers/efs-csi-controller-*_kube-system_*.log, /var/log/containers/efs-csi-node-*_kube-system_*.log
                    multiline.parser    docker, cri
                    DB                  /var/fluent-bit/state/flb-aws-efs-csi-driver.db
                    Mem_Buf_Limit       50MB
                    Skip_Long_Lines     On
                    Refresh_Interval    10
                    Rotate_Wait         30
                    storage.type        filesystem
                    Read_from_Head      ${READ_FROM_HEAD}

                  [FILTER]
                    Name                kubernetes
                    Match               aws-efs-csi-driver.*
                    Kube_Tag_Prefix     aws-efs-csi-driver.var.log.containers.
                    Kube_URL            https://kubernetes.default.svc:443
                    Merge_Log           On
                    Merge_Log_Key       log_processed
                    K8S-Logging.Parser  On
                    K8S-Logging.Exclude Off
                    Labels              Off
                    Annotations         Off
                    Use_Kubelet         On
                    Kubelet_Port        10250
                    Buffer_Size         0
                    Use_Pod_Association On
                  
                  [FILTER]
                    Name                nest
                    Match               aws-efs-csi-driver.*
                    Operation           lift
                    Nested_under        kubernetes
                  
                  [FILTER]
                    Name                modify
                    Match               aws-efs-csi-driver.*
                    Rename              pod_name pod
                    Rename              container_name container
                    Rename              namespace_name namespace
                    Rename              host node
                  
                  [FILTER]
                    Name                record_modifier
                    Match               aws-efs-csi-driver.*
                    Allowlist_key       log
                    Allowlist_key       pod
                    Allowlist_key       container
                    Allowlist_key       namespace
                    Allowlist_key       node

                  [OUTPUT]
                    Name                cloudwatch_logs
                    Match               aws-efs-csi-driver.*
                    region              ${AWS_REGION}
                    log_group_name      /aws/eks/${CLUSTER_NAME}/aws-efs-csi-driver
                    log_stream_prefix   aws-efs-csi-driver-
                    log_stream_template $pod.FROM.${HOST_NAME}
                    auto_create_group   true
                    extra_user_agent    container-insights
                    add_entity          true
                cluster-autoscaler.conf: |
                  [INPUT]
                    Name                tail
                    Tag                 cluster-autoscaler.*
                    Path                /var/log/containers/cluster-autoscaler-*_kube-system_*.log
                    multiline.parser    docker, cri
                    DB                  /var/fluent-bit/state/flb-cluster-autoscaler.db
                    Mem_Buf_Limit       50MB
                    Skip_Long_Lines     On
                    Refresh_Interval    10
                    Rotate_Wait         30
                    storage.type        filesystem
                    Read_from_Head      ${READ_FROM_HEAD}

                  [FILTER]
                    Name                kubernetes
                    Match               cluster-autoscaler.*
                    Kube_Tag_Prefix     cluster-autoscaler.var.log.containers.
                    Kube_URL            https://kubernetes.default.svc:443
                    Merge_Log           On
                    Merge_Log_Key       log_processed
                    K8S-Logging.Parser  On
                    K8S-Logging.Exclude Off
                    Labels              Off
                    Annotations         Off
                    Use_Kubelet         On
                    Kubelet_Port        10250
                    Buffer_Size         0
                    Use_Pod_Association On
                  
                  [FILTER]
                    Name                nest
                    Match               cluster-autoscaler.*
                    Operation           lift
                    Nested_under        kubernetes
                  
                  [FILTER]
                    Name                modify
                    Match               cluster-autoscaler.*
                    Rename              pod_name pod
                    Rename              container_name container
                    Rename              namespace_name namespace
                    Rename              host node
                  
                  [FILTER]
                    Name                record_modifier
                    Match               cluster-autoscaler.*
                    Allowlist_key       log
                    Allowlist_key       pod
                    Allowlist_key       container
                    Allowlist_key       namespace
                    Allowlist_key       node

                  [OUTPUT]
                    Name                cloudwatch_logs
                    Match               cluster-autoscaler.*
                    region              ${AWS_REGION}
                    log_group_name      /aws/eks/${CLUSTER_NAME}/cluster-autoscaler
                    log_stream_prefix   cluster-autoscaler-
                    log_stream_template $pod.FROM.${HOST_NAME}
                    auto_create_group   true
                    extra_user_agent    container-insights
                    add_entity          true
                aws-load-balancer-controller.conf: |
                  [INPUT]
                    Name                tail
                    Tag                 aws-load-balancer-controller.*
                    Path                /var/log/containers/aws-load-balancer-controller-*_kube-system_*.log
                    multiline.parser    docker, cri
                    DB                  /var/fluent-bit/state/flb-aws-load-balancer-controller.db
                    Mem_Buf_Limit       50MB
                    Skip_Long_Lines     On
                    Refresh_Interval    10
                    Rotate_Wait         30
                    storage.type        filesystem
                    Read_from_Head      ${READ_FROM_HEAD}

                  [FILTER]
                    Name                kubernetes
                    Match               aws-load-balancer-controller.*
                    Kube_Tag_Prefix     aws-load-balancer-controller.var.log.containers.
                    Kube_URL            https://kubernetes.default.svc:443
                    Merge_Log           On
                    Merge_Log_Key       log_processed
                    K8S-Logging.Parser  On
                    K8S-Logging.Exclude Off
                    Labels              Off
                    Annotations         Off
                    Use_Kubelet         On
                    Kubelet_Port        10250
                    Buffer_Size         0
                    Use_Pod_Association On
                  
                  [FILTER]
                    Name                nest
                    Match               aws-load-balancer-controller.*
                    Operation           lift
                    Nested_under        kubernetes
                  
                  [FILTER]
                    Name                modify
                    Match               aws-load-balancer-controller.*
                    Rename              pod_name pod
                    Rename              container_name container
                    Rename              namespace_name namespace
                    Rename              host node
                  
                  [FILTER]
                    Name                record_modifier
                    Match               aws-load-balancer-controller.*
                    Allowlist_key       log
                    Allowlist_key       pod
                    Allowlist_key       container
                    Allowlist_key       namespace
                    Allowlist_key       node

                  [OUTPUT]
                    Name                cloudwatch_logs
                    Match               aws-load-balancer-controller.*
                    region              ${AWS_REGION}
                    log_group_name      /aws/eks/${CLUSTER_NAME}/aws-load-balancer-controller
                    log_stream_prefix   aws-load-balancer-controller-
                    log_stream_template $pod.FROM.${HOST_NAME}
                    auto_create_group   true
                    extra_user_agent    container-insights
                    add_entity          true
  CloudWatchObservabilityIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - pods.eks.amazonaws.com
            Action:
              - sts:AssumeRole
              - sts:TagSession
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy

Outputs:
  VsCode:
    Value: !Sub http://${BastionEc2.PublicIp}:8000
    Description: VsCode on BastionEC2
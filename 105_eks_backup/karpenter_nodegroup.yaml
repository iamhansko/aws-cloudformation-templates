Transform: AWS::LanguageExtensions
Parameters:
  InboundFromAnywhere:
    Type: String
    Default: "False"
    AllowedValues: ["True", "False"]
    Description: SecurityGroup Inbound Rule (Source 0.0.0.0/0)
  KubernetesVersion:
    Description: EKS Cluster Kubernetes Version (1.XX)
    Type: String
    Default: "1.34"
    AllowedValues: ["1.32", "1.33", "1.34"]
  AmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64
  VsCodeVersion:
    Type: String
    Default: "4.108.1"
Conditions:
  SecurityGroupInboundFromAnywhere: !Equals [!Ref InboundFromAnywhere, "True"]

Mappings:
  AzMapping: 
    a:
      PublicSubnetCidr: 10.0.0.0/24
      PrivateSubnetCidr: 10.0.1.0/24
    b: 
      PublicSubnetCidr: 10.0.2.0/24
      PrivateSubnetCidr: 10.0.3.0/24
    c: 
      PublicSubnetCidr: 10.0.4.0/24
      PrivateSubnetCidr: 10.0.5.0/24

Resources:
  KeyPair:
    Type: AWS::EC2::KeyPair
    Properties:
      KeyName: !Sub
        - key-${Id}
        - Id: !Select [3, !Split ['-', !Select [2, !Split ['/', !Ref AWS::StackId]]]]
  
  Vpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: True
      EnableDnsHostnames: True
      Tags:
        - Key: Name
          Value: vpc

  # PublicSubnets
  Fn::ForEach::PublicSubnets:
    - Az
    - [a, c]
    - PublicSubnet${Az}:
        Type: AWS::EC2::Subnet
        Properties:
          AvailabilityZone: !Sub ${AWS::Region}${Az}
          CidrBlock: !FindInMap [AzMapping, !Ref Az, PublicSubnetCidr]
          MapPublicIpOnLaunch: true
          Tags:
            - Key: Name
              Value: !Sub public-subnet-${Az}
          VpcId: !Ref Vpc
      PublicSubnet${Az}RouteTableAssociation:
        Type: AWS::EC2::SubnetRouteTableAssociation
        Properties:
          RouteTableId: !Ref PublicSubnetRouteTable
          SubnetId: 
            Ref: !Sub PublicSubnet${Az}
  PublicSubnetRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      Tags:
        - Key: Name
          Value: public-rt
      VpcId: !Ref Vpc
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: igw
  VpcInternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref Vpc
  PublicSubnetRoute:
    Type: AWS::EC2::Route
    DependsOn:
      - VpcInternetGatewayAttachment
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
      RouteTableId: !Ref PublicSubnetRouteTable
  
  # PrivateSubnets
  Fn::ForEach::PrivateSubnets:
    - Az
    - [a, c]
    - PrivateSubnet${Az}:
        Type: AWS::EC2::Subnet
        Properties:
          VpcId: !Ref Vpc
          CidrBlock: !FindInMap [AzMapping, !Ref Az, PrivateSubnetCidr]
          AvailabilityZone: !Sub ${AWS::Region}${Az}
          Tags:
            - Key: Name
              Value: !Sub private-subnet-${Az}
      NatgatewayElasticIp${Az}:
        Type: AWS::EC2::EIP
      PrivateSubnet${Az}RouteTableAssociation:
        Type: AWS::EC2::SubnetRouteTableAssociation
        Properties:
          RouteTableId: !Ref PrivateSubnetRouteTable
          SubnetId:
            Ref: !Sub PrivateSubnet${Az}
  PrivateSubnetRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: !Sub private-rt
  PrivateSubnetRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway
      RouteTableId: !Ref PrivateSubnetRouteTable
  NatGateway:
    Type: AWS::EC2::NatGateway
    DependsOn:
      - VpcInternetGatewayAttachment
    Properties:
      VpcId: !Ref Vpc
      AvailabilityMode: regional
      AvailabilityZoneAddresses:
        - AvailabilityZone: !Sub ${AWS::Region}a
          AllocationIds: 
            - !GetAtt NatgatewayElasticIpa.AllocationId
        - AvailabilityZone: !Sub ${AWS::Region}c
          AllocationIds: 
            - !GetAtt NatgatewayElasticIpc.AllocationId
      Tags: 
        - Key : Name
          Value : !Sub regional-natgw
  
  VsCodeEc2:
    Type: AWS::EC2::Instance
    DependsOn:
      - AddOnNodeGroup
      - AwsLoadBalancerControllerRolePodIdentityAssociation
      - KarpenterControllerIamRolePodIdentityAssociation
    CreationPolicy:
      ResourceSignal:
        Count: '1'                
        Timeout: PT15M
    Properties:
      ImageId: !Ref AmiId
      InstanceType: t3.medium
      KeyName: !Ref KeyPair
      NetworkInterfaces: 
        - AssociatePublicIpAddress: True
          DeviceIndex: 0
          SubnetId: !Ref PublicSubneta
          GroupSet: 
            - !GetAtt PrimaryCluster.ClusterSecurityGroupId
            - !GetAtt SecondaryCluster.ClusterSecurityGroupId
            - !Ref VsCodeEc2SecurityGroup
      Tags: 
        - Key: Name
          Value: vscode
      IamInstanceProfile: !Ref VsCodeEc2InstanceProfile
      UserData: 
        # sudo tail -f /var/log/cloud-init-output.log
        Fn::Base64: !Sub |
          #!/bin/bash
          dnf update -yq
          dnf install -yq git
          dnf groupinstall -yq "Development Tools"

          export VSC_VERSION="${VsCodeVersion}"
          wget https://github.com/coder/code-server/releases/download/v$VSC_VERSION/code-server-$VSC_VERSION-linux-amd64.tar.gz
          tar -xzf code-server-$VSC_VERSION-linux-amd64.tar.gz
          mv code-server-$VSC_VERSION-linux-amd64 /usr/local/lib/code-server
          ln -s /usr/local/lib/code-server/bin/code-server /usr/local/bin/code-server
          mkdir -p /home/ec2-user/.config/code-server
          cat <<EOF > /home/ec2-user/.config/code-server/config.yaml
          bind-addr: 0.0.0.0:8000
          auth: none
          cert: false
          EOF
          chown -R ec2-user:ec2-user /home/ec2-user/.config
          cat <<EOF > /etc/systemd/system/code-server.service
          [Unit]
          Description=VS Code Server
          After=network.target
          [Service]
          Type=simple
          User=ec2-user
          ExecStart=/usr/local/bin/code-server --config /home/ec2-user/.config/code-server/config.yaml /home/ec2-user
          Restart=always
          [Install]
          WantedBy=multi-user.target
          EOF
          systemctl daemon-reload
          systemctl enable code-server
          systemctl start code-server

          sudo -Eu ec2-user bash << 'EOF'
          cd /home/ec2-user
          mkdir -p /home/ec2-user/bin
          curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/1.33.3/2025-08-03/bin/linux/amd64/kubectl
          chmod +x kubectl
          mv kubectl /home/ec2-user/bin/kubectl
          export PATH=/home/ec2-user/bin:$PATH
          echo "export PATH=/home/ec2-user/bin:$PATH" >> ~/.bashrc
          echo "alias k=kubectl" >> ~/.bashrc
          echo "complete -o default -F __start_kubectl k" >> ~/.bashrc
          echo "source <(kubectl completion bash)" >> ~/.bashrc
          exec bash

          curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
          sudo mv /tmp/eksctl /usr/local/bin

          curl -fsSL -o /home/ec2-user/get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-4
          chmod 700 /home/ec2-user/get_helm.sh
          /home/ec2-user/get_helm.sh
          rm /home/ec2-user/get_helm.sh

          aws eks update-kubeconfig --region ${AWS::Region} --name ${PrimaryCluster}
          helm repo add eks https://aws.github.io/eks-charts
          helm repo update eks
          helm install aws-load-balancer-controller eks/aws-load-balancer-controller -n kube-system --wait \
          --set clusterName=${PrimaryCluster} \
          --set serviceAccount.name=aws-load-balancer-controller \
          --set region=${AWS::Region} \
          --set vpcId=${Vpc} \
          --set tolerations[0].key=nodegroup \
          --set tolerations[0].value=addon \
          --set tolerations[0].operator=Equal \
          --set tolerations[0].effect=NoSchedule \
          --set nodeSelector.nodegroup=addon
          sleep 60

          helm registry logout public.ecr.aws
          helm upgrade --install karpenter oci://public.ecr.aws/karpenter/karpenter --version 1.8.6 --namespace kube-system \
          --set settings.clusterName=${PrimaryCluster} \
          --set controller.resources.requests.cpu=1 \
          --set controller.resources.requests.memory=1Gi \
          --set controller.resources.limits.cpu=1 \
          --set controller.resources.limits.memory=1Gi \
          --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"="${KarpenterControllerIamRole.Arn}" \
          --set controller.resources.limits.memory=1Gi \
          --set nodeSelector.nodegroup=addon \
          --set tolerations[0].key=CriticalAddonsOnly \
          --set tolerations[0].operator=Exists \
          --set tolerations[1].effect=NoSchedule \
          --set tolerations[1].key=nodegroup \
          --set tolerations[1].operator=Equal \
          --set tolerations[1].value=addon \
          --wait

          mkdir -p /home/ec2-user/manifests

          echo 'kind: StorageClass
          apiVersion: storage.k8s.io/v1
          metadata:
            name: efs-sc
          provisioner: efs.csi.aws.com
          parameters:
            provisioningMode: efs-ap
            fileSystemId: ${EfsFileSystem}
            directoryPerms: "700"
          ---
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: efs-pvc
          spec:
            accessModes:
              - ReadWriteMany
            storageClassName: efs-sc
            resources:
              requests:
                storage: 5Gi
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: efs
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: efs
            template:
              metadata:
                labels:
                  app: efs
              spec:
                containers:
                - name: app
                  image: rockylinux:8
                  command: ["/bin/sh"]
                  args: ["-c", "while true; do echo $(date -u) >> /data/out; sleep 5; done"]
                  volumeMounts:
                  - name: persistent-storage
                    mountPath: /data
                volumes:
                - name: persistent-storage
                  persistentVolumeClaim:
                    claimName: efs-pvc' > /home/ec2-user/manifests/deployment_efs.yaml
          kubectl apply -f /home/ec2-user/manifests/deployment_efs.yaml

          echo 'apiVersion: storage.k8s.io/v1
          kind: StorageClass
          metadata:
            name: ebs-sc
          provisioner: ebs.csi.aws.com
          volumeBindingMode: WaitForFirstConsumer
          parameters:
            csi.storage.k8s.io/fstype: xfs
            type: io1
            iopsPerGB: "50"
            encrypted: "true"
          allowedTopologies:
          - matchLabelExpressions:
            - key: topology.kubernetes.io/zone
              values:
              - ${AWS::Region}a
              - ${AWS::Region}c
          ---
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: ebs-pvc
          spec:
            accessModes:
              - ReadWriteOnce
            storageClassName: ebs-sc
            resources:
              requests:
                storage: 4Gi
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ebs
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: ebs
            template:
              metadata:
                labels:
                  app: ebs
              spec:
                containers:
                - name: app
                  image: public.ecr.aws/amazonlinux/amazonlinux
                  command: ["/bin/sh"]
                  args: ["-c", "while true; do echo $(date -u) >> /data/out.txt; sleep 5; done"]
                  volumeMounts:
                  - name: persistent-storage
                    mountPath: /data
                volumes:
                - name: persistent-storage
                  persistentVolumeClaim:
                    claimName: ebs-pvc' > /home/ec2-user/manifests/deployment_ebs.yaml
          kubectl apply -f /home/ec2-user/manifests/deployment_ebs.yaml

          echo $'apiVersion: v1
          kind: PersistentVolume
          metadata:
            name: s3-pv
          spec:
            capacity:
              storage: 20Gi
            accessModes:
              - ReadWriteMany
            storageClassName: ""
            claimRef:
              namespace: default
              name: s3-pvc 
            mountOptions:
              - allow-delete
              - region ${AWS::Region}
              - prefix /
            csi:
              driver: s3.csi.aws.com
              volumeHandle: s3-csi-driver-volume
              volumeAttributes:
                bucketName: ${S3Bucket}
          ---
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: s3-pvc
          spec:
            accessModes:
              - ReadWriteMany
            storageClassName: ""
            resources:
              requests:
                storage: 20Gi 
            volumeName: s3-pv
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: s3
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: s3
            template:
              metadata:
                labels:
                  app: s3
              spec:
                containers:
                  - name: app
                    image: ubuntu
                    command: ["/bin/sh"]
                    args: ["-c", "echo \'Hello from the container!\' >> /data/$(date -u).txt; tail -f /dev/null"]
                    volumeMounts:
                      - name: persistent-storage
                        mountPath: /data
                volumes:
                  - name: persistent-storage
                    persistentVolumeClaim:
                      claimName: s3-pvc' > /home/ec2-user/manifests/deployment_s3.yaml
          kubectl apply -f /home/ec2-user/manifests/deployment_s3.yaml

          echo 'apiVersion: v1
          kind: Pod
          metadata:
            name: pod-ec2
          spec:
            containers:
            - name: nginx
              image: nginx' > /home/ec2-user/manifests/pod_ec2.yaml
          kubectl apply -f /home/ec2-user/manifests/pod_ec2.yaml

          echo 'apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: deployment-ec2
          spec:
            replicas: 4
            selector:
              matchLabels:
                deployment: ec2
            template:
              metadata:
                labels:
                  deployment: ec2
              spec:
                containers:
                - name: nginx
                  image: nginx' > /home/ec2-user/manifests/deployment_ec2.yaml
          kubectl apply -f /home/ec2-user/manifests/deployment_ec2.yaml

          kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.13.0/docs/examples/2048/2048_full.yaml

          echo 'apiVersion: karpenter.k8s.aws/v1
          kind: EC2NodeClass
          metadata:
            name: default
          spec:
            role: ${EksNodeIamRole}
            amiSelectorTerms:
              - alias: al2023@latest
            subnetSelectorTerms:
              - tags:
                  Name: "private-subnet-*"
            securityGroupSelectorTerms:
              - tags:
                  aws:eks:cluster-name: "*Cluster-*"
          ---
          apiVersion: karpenter.sh/v1
          kind: NodePool
          metadata:
            name: default
          spec:
            template:
              spec:
                requirements:
                  - key: kubernetes.io/arch
                    operator: In
                    values: ["amd64"]
                  - key: kubernetes.io/os
                    operator: In
                    values: ["linux"]
                  - key: karpenter.sh/capacity-type
                    operator: In
                    values: ["on-demand"]
                  - key: karpenter.k8s.aws/instance-category
                    operator: In
                    values: ["t", "m", "c"]
                  - key: karpenter.k8s.aws/instance-generation
                    operator: Gt
                    values: ["2"]
                nodeClassRef:
                  group: karpenter.k8s.aws
                  kind: EC2NodeClass
                  name: default
                expireAfter: 720h
            limits:
              cpu: 1000
            disruption:
              consolidationPolicy: WhenEmptyOrUnderutilized
              consolidateAfter: 10m' > /home/ec2-user/manifests/nodepool_default.yaml
          kubectl apply -f /home/ec2-user/manifests/nodepool_default.yaml

          EOF

          aws iam create-service-linked-role --aws-service-name spot.amazonaws.com || true

          /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource VsCodeEc2 --region ${AWS::Region}
  VsCodeEc2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security Group
      GroupName: vscode-sg
      VpcId: !Ref Vpc
      SecurityGroupIngress:
        !If [SecurityGroupInboundFromAnywhere, [{
          "IpProtocol": "tcp",
          "FromPort": 8000,
          "ToPort": 8000,
          "CidrIp": "0.0.0.0/0"
        }], []]
      Tags:
        - Key: Name
          Value: vscode-sg
  VsCodeEc2IamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AdministratorAccess
  VsCodeEc2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles: 
        - !Ref VsCodeEc2IamRole
  VsCodeEc2IamAccessEntry:
    Type: AWS::EKS::AccessEntry
    Properties:
      AccessPolicies: 
        - AccessScope: 
            Type: cluster
          PolicyArn: arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy
      ClusterName: !Ref PrimaryCluster
      PrincipalArn: !GetAtt VsCodeEc2IamRole.Arn
      Type: STANDARD

  PrimaryCluster:
    Type: AWS::EKS::Cluster
    Properties:
      Version: !Ref KubernetesVersion
      AccessConfig: 
        AuthenticationMode: API_AND_CONFIG_MAP
        BootstrapClusterCreatorAdminPermissions: true
      BootstrapSelfManagedAddons: false
      Logging: 
        ClusterLogging: 
          EnabledTypes: 
            - Type: api
            - Type: audit
            - Type: authenticator
            - Type: controllerManager
            - Type: scheduler
      ResourcesVpcConfig: 
        EndpointPrivateAccess: true
        EndpointPublicAccess: true
        SubnetIds: 
          - !Ref PublicSubneta
          - !Ref PublicSubnetc
          - !Ref PrivateSubneta
          - !Ref PrivateSubnetc
      RoleArn: !GetAtt EksClusterIamRole.Arn
      KubernetesNetworkConfig:
        IpFamily: ipv4
        ServiceIpv4Cidr: 172.20.0.0/16
  EksClusterIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - eks.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
  PrimaryClusterOidcProvider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      Url: !GetAtt PrimaryCluster.OpenIdConnectIssuerUrl
      ClientIdList: 
        - sts.amazonaws.com

  VpcCniAddOn:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: vpc-cni
      ClusterName: !Ref PrimaryCluster
      ResolveConflicts: OVERWRITE
  KubeProxyAddOn:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: kube-proxy
      ClusterName: !Ref PrimaryCluster
      ResolveConflicts: OVERWRITE
  CoreDnsAddOn:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: coredns
      ClusterName: !Ref PrimaryCluster
      ResolveConflicts: OVERWRITE
      ConfigurationValues: |
        nodeSelector:
          nodegroup: addon
        tolerations:
          - effect: NoSchedule
            key: nodegroup
            operator: Equal
            value: addon
  PodIdentityAgentAddon:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: eks-pod-identity-agent
      ClusterName: !Ref PrimaryCluster
      ResolveConflicts: OVERWRITE
  EbsCsiDriverAddon:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: aws-ebs-csi-driver
      ClusterName: !Ref PrimaryCluster
      ResolveConflicts: OVERWRITE
      ConfigurationValues: |
        controller:
          nodeSelector:
            nodegroup: addon
          tolerations:
            - effect: NoSchedule
              key: nodegroup
              operator: Equal
              value: addon
      PodIdentityAssociations: 
        - RoleArn: !GetAtt EbsCsiDriverAddonIamRole.Arn
          ServiceAccount: ebs-csi-controller-sa
  EbsCsiDriverAddonIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: pods.eks.amazonaws.com
            Action:
              - sts:AssumeRole
              - sts:TagSession
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy
  EfsCsiDriverAddon:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: aws-efs-csi-driver
      ClusterName: !Ref PrimaryCluster
      ResolveConflicts: OVERWRITE
      ConfigurationValues: |
        controller:
          nodeSelector:
            nodegroup: addon
          tolerations:
            - effect: NoSchedule
              key: nodegroup
              operator: Equal
              value: addon
      PodIdentityAssociations: 
        - RoleArn: !GetAtt EfsCsiDriverAddonIamRole.Arn
          ServiceAccount: efs-csi-controller-sa
  EfsCsiDriverAddonIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: pods.eks.amazonaws.com
            Action:
              - sts:AssumeRole
              - sts:TagSession
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEFSCSIDriverPolicy
  MountpointS3CsiDriverAddon:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: aws-mountpoint-s3-csi-driver
      ClusterName: !Ref PrimaryCluster
      ResolveConflicts: OVERWRITE
      ConfigurationValues: |
        controller:
          nodeSelector:
            nodegroup: addon
          tolerations:
            - effect: NoSchedule
              key: nodegroup
              operator: Equal
              value: addon
      PodIdentityAssociations:
        - RoleArn: !GetAtt MountpointS3CsiDriverIamRole.Arn
          ServiceAccount: s3-csi-driver-sa
  MountpointS3CsiDriverIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: pods.eks.amazonaws.com
            Action:
              - sts:AssumeRole
              - sts:TagSession
      Policies:
        # https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/s3-csi-create.html
        - PolicyName: MountpointS3Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: [ !Sub "${S3Bucket.Arn}" ]
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:AbortMultipartUpload
                  - s3:DeleteObject
                Resource: [ !Sub "${S3Bucket.Arn}/*" ]
  AwsLoadBalancerControllerRole:
    # https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/refs/heads/main/docs/install/iam_policy.json
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: pods.eks.amazonaws.com
            Action:
              - sts:AssumeRole
              - sts:TagSession
      Policies:
        - PolicyName: AWSLoadBalancerControllerPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - iam:CreateServiceLinkedRole
                Resource: "*"
                Condition:
                  StringEquals: 
                    iam:AWSServiceName: elasticloadbalancing.amazonaws.com
              - Effect: Allow
                Action: 
                  - ec2:*
                  - elasticloadbalancing:*
                Resource: "*"
              - Effect: Allow
                Action: 
                  - cognito-idp:DescribeUserPoolClient
                  - acm:ListCertificates
                  - acm:DescribeCertificate
                  - iam:ListServerCertificates
                  - iam:GetServerCertificate
                  - waf-regional:GetWebACL
                  - waf-regional:GetWebACLForResource
                  - waf-regional:AssociateWebACL
                  - waf-regional:DisassociateWebACL
                  - wafv2:GetWebACL
                  - wafv2:GetWebACLForResource
                  - wafv2:AssociateWebACL
                  - wafv2:DisassociateWebACL
                  - shield:GetSubscriptionState
                  - shield:DescribeProtection
                  - shield:CreateProtection
                  - shield:DeleteProtection
                Resource: "*"
  AwsLoadBalancerControllerRolePodIdentityAssociation:
    Type: AWS::EKS::PodIdentityAssociation
    Properties:
      ClusterName: !Ref PrimaryCluster
      Namespace: kube-system
      RoleArn: !GetAtt AwsLoadBalancerControllerRole.Arn
      ServiceAccount: aws-load-balancer-controller
  
  KarpenterControllerIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: pods.eks.amazonaws.com
            Action:
              - sts:AssumeRole
              - sts:TagSession
      ManagedPolicyArns:
        # https://raw.githubusercontent.com/aws/karpenter-provider-aws/v1.8.6/website/content/en/preview/getting-started/getting-started-with-karpenter/cloudformation.yaml
        - !GetAtt KarpenterControllerPolicy.PolicyArn
  KarpenterControllerPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument: !Sub |
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "AllowScopedEC2InstanceAccessActions",
              "Effect": "Allow",
              "Resource": [
                "arn:${AWS::Partition}:ec2:${AWS::Region}::image/*",
                "arn:${AWS::Partition}:ec2:${AWS::Region}::snapshot/*",
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:security-group/*",
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:subnet/*",
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:capacity-reservation/*"
              ],
              "Action": [
                "ec2:RunInstances",
                "ec2:CreateFleet"
              ]
            },
            {
              "Sid": "AllowScopedEC2LaunchTemplateAccessActions",
              "Effect": "Allow",
              "Resource": "arn:${AWS::Partition}:ec2:${AWS::Region}:*:launch-template/*",
              "Action": [
                "ec2:RunInstances",
                "ec2:CreateFleet"
              ],
              "Condition": {
                "StringLike": {
                  "aws:ResourceTag/karpenter.sh/nodepool": "*"
                }
              }
            },
            {
              "Sid": "AllowScopedEC2InstanceActionsWithTags",
              "Effect": "Allow",
              "Resource": [
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:fleet/*",
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:instance/*",
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:volume/*",
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:network-interface/*",
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:launch-template/*",
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:spot-instances-request/*",
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:capacity-reservation/*"
              ],
              "Action": [
                "ec2:RunInstances",
                "ec2:CreateFleet",
                "ec2:CreateLaunchTemplate"
              ],
              "Condition": {
                "StringLike": {
                  "aws:RequestTag/karpenter.sh/nodepool": "*"
                }
              }
            },
            {
              "Sid": "AllowScopedResourceCreationTagging",
              "Effect": "Allow",
              "Resource": [
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:fleet/*",
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:instance/*",
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:volume/*",
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:network-interface/*",
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:launch-template/*",
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:spot-instances-request/*"
              ],
              "Action": "ec2:CreateTags",
              "Condition": {
                "StringLike": {
                  "aws:RequestTag/karpenter.sh/nodepool": "*"
                }
              }
            },
            {
              "Sid": "AllowScopedResourceTagging",
              "Effect": "Allow",
              "Resource": "arn:${AWS::Partition}:ec2:${AWS::Region}:*:instance/*",
              "Action": "ec2:CreateTags",
              "Condition": {
                "StringLike": {
                  "aws:ResourceTag/karpenter.sh/nodepool": "*"
                },
                "ForAllValues:StringEquals": {
                  "aws:TagKeys": [
                    "eks:eks-cluster-name",
                    "karpenter.sh/nodeclaim",
                    "Name"
                  ]
                }
              }
            },
            {
              "Sid": "AllowScopedDeletion",
              "Effect": "Allow",
              "Resource": [
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:instance/*",
                "arn:${AWS::Partition}:ec2:${AWS::Region}:*:launch-template/*"
              ],
              "Action": [
                "ec2:TerminateInstances",
                "ec2:DeleteLaunchTemplate"
              ],
              "Condition": {
                "StringLike": {
                  "aws:ResourceTag/karpenter.sh/nodepool": "*"
                }
              }
            },
            {
              "Sid": "AllowRegionalReadActions",
              "Effect": "Allow",
              "Resource": "*",
              "Action": [
                "ec2:DescribeCapacityReservations",
                "ec2:DescribeImages",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceTypeOfferings",
                "ec2:DescribeInstanceTypes",
                "ec2:DescribeLaunchTemplates",
                "ec2:DescribeSecurityGroups",
                "ec2:DescribeSpotPriceHistory",
                "ec2:DescribeSubnets"
              ],
              "Condition": {
                "StringEquals": {
                  "aws:RequestedRegion": "${AWS::Region}"
                }
              }
            },
            {
              "Sid": "AllowSSMReadActions",
              "Effect": "Allow",
              "Resource": "arn:${AWS::Partition}:ssm:${AWS::Region}::parameter/aws/service/*",
              "Action": "ssm:GetParameter"
            },
            {
              "Sid": "AllowPricingReadActions",
              "Effect": "Allow",
              "Resource": "*",
              "Action": "pricing:GetProducts"
            },
            {
              "Sid": "AllowInterruptionQueueActions",
              "Effect": "Allow",
              "Resource": "${KarpenterInterruptionQueue.Arn}",
              "Action": [
                "sqs:DeleteMessage",
                "sqs:GetQueueUrl",
                "sqs:ReceiveMessage"
              ]
            },
            {
              "Sid": "AllowPassingInstanceRole",
              "Effect": "Allow",
              "Resource": "${EksNodeIamRole.Arn}",
              "Action": "iam:PassRole",
              "Condition": {
                "StringEquals": {
                  "iam:PassedToService": [
                    "ec2.amazonaws.com",
                    "ec2.amazonaws.com.cn"
                  ]
                }
              }
            },
            {
              "Sid": "AllowScopedInstanceProfileCreationActions",
              "Effect": "Allow",
              "Resource": "arn:${AWS::Partition}:iam::${AWS::AccountId}:instance-profile/*",
              "Action": [
                "iam:CreateInstanceProfile"
              ],
              "Condition": {
                "StringEquals": {
                  "aws:RequestTag/topology.kubernetes.io/region": "${AWS::Region}"
                },
                "StringLike": {
                  "aws:RequestTag/karpenter.k8s.aws/ec2nodeclass": "*"
                }
              }
            },
            {
              "Sid": "AllowScopedInstanceProfileTagActions",
              "Effect": "Allow",
              "Resource": "arn:${AWS::Partition}:iam::${AWS::AccountId}:instance-profile/*",
              "Action": [
                "iam:TagInstanceProfile"
              ],
              "Condition": {
                "StringEquals": {
                  "aws:ResourceTag/topology.kubernetes.io/region": "${AWS::Region}",
                  "aws:RequestTag/topology.kubernetes.io/region": "${AWS::Region}"
                },
                "StringLike": {
                  "aws:ResourceTag/karpenter.k8s.aws/ec2nodeclass": "*",
                  "aws:RequestTag/karpenter.k8s.aws/ec2nodeclass": "*"
                }
              }
            },
            {
              "Sid": "AllowScopedInstanceProfileActions",
              "Effect": "Allow",
              "Resource": "arn:${AWS::Partition}:iam::${AWS::AccountId}:instance-profile/*",
              "Action": [
                "iam:AddRoleToInstanceProfile",
                "iam:RemoveRoleFromInstanceProfile",
                "iam:DeleteInstanceProfile"
              ],
              "Condition": {
                "StringEquals": {
                  "aws:ResourceTag/topology.kubernetes.io/region": "${AWS::Region}"
                },
                "StringLike": {
                  "aws:ResourceTag/karpenter.k8s.aws/ec2nodeclass": "*"
                }
              }
            },
            {
              "Sid": "AllowInstanceProfileReadActions",
              "Effect": "Allow",
              "Resource": "arn:${AWS::Partition}:iam::${AWS::AccountId}:instance-profile/*",
              "Action": "iam:GetInstanceProfile"
            },
            {
              "Sid": "AllowUnscopedInstanceProfileListAction",
              "Effect": "Allow",
              "Resource": "*",
              "Action": "iam:ListInstanceProfiles"
            },
            {
              "Sid": "AllowAPIServerEndpointDiscovery",
              "Effect": "Allow",
              "Resource": "arn:${AWS::Partition}:eks:${AWS::Region}:${AWS::AccountId}:cluster/*",
              "Action": "eks:DescribeCluster"
            }
          ]
        }
  KarpenterControllerIamRolePodIdentityAssociation:
    Type: AWS::EKS::PodIdentityAssociation
    Properties:
      ClusterName: !Ref PrimaryCluster
      Namespace: kube-system
      RoleArn: !GetAtt KarpenterControllerIamRole.Arn
      ServiceAccount: karpenter
  KarpenterInterruptionQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 300
      SqsManagedSseEnabled: true
  KarpenterInterruptionQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref KarpenterInterruptionQueue
      PolicyDocument:
        Id: EC2InterruptionPolicy
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - events.amazonaws.com
                - sqs.amazonaws.com
            Action: sqs:SendMessage
            Resource: !GetAtt KarpenterInterruptionQueue.Arn
          - Sid: DenyHTTP
            Effect: Deny
            Action: sqs:*
            Resource: !GetAtt KarpenterInterruptionQueue.Arn
            Condition:
              Bool:
                aws:SecureTransport: false
            Principal: "*"
  ScheduledChangeRule:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source:
          - aws.health
        detail-type:
          - AWS Health Event
      Targets:
        - Id: KarpenterInterruptionQueueTarget
          Arn: !GetAtt KarpenterInterruptionQueue.Arn
  SpotInterruptionRule:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source:
          - aws.ec2
        detail-type:
          - EC2 Spot Instance Interruption Warning
      Targets:
        - Id: KarpenterInterruptionQueueTarget
          Arn: !GetAtt KarpenterInterruptionQueue.Arn
  RebalanceRule:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source:
          - aws.ec2
        detail-type:
          - EC2 Instance Rebalance Recommendation
      Targets:
        - Id: KarpenterInterruptionQueueTarget
          Arn: !GetAtt KarpenterInterruptionQueue.Arn
  InstanceStateChangeRule:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source:
          - aws.ec2
        detail-type:
          - EC2 Instance State-change Notification
      Targets:
        - Id: KarpenterInterruptionQueueTarget
          Arn: !GetAtt KarpenterInterruptionQueue.Arn
  
  AddOnNodeGroup:
    Type: AWS::EKS::Nodegroup
    Properties:
      NodegroupName: addon-mng
      AmiType: AL2023_x86_64_STANDARD
      InstanceTypes: 
        - t3.large #c5.large
      CapacityType: ON_DEMAND
      ClusterName: !Ref PrimaryCluster
      ForceUpdateEnabled: true
      Labels: 
        nodegroup: addon
      Taints:
        - Effect: NO_SCHEDULE
          Key: nodegroup
          Value: addon
      NodeRole: !GetAtt EksNodeIamRole.Arn
      ScalingConfig: 
        DesiredSize: 2
        MaxSize: 4
        MinSize: 2
      Subnets: 
        - !Ref PrivateSubneta
        - !Ref PrivateSubnetc
      LaunchTemplate:
        Id: !Ref AddOnLaunchTemplate
  AddOnLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: addon-nodegroup-launchtemplate
      LaunchTemplateData: 
        KeyName: !Ref KeyPair
        TagSpecifications: 
          - ResourceType: instance
            Tags: 
              - Key: Name
                Value: addon-mng
  EksNodeIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
  
  EfsFileSystem:
    Type: AWS::EFS::FileSystem
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      PerformanceMode: generalPurpose
  # EfsMountTargets
  Fn::ForEach::EfsMountTargets:
    - Az
    - [a, c]
    - FargateEfsMountTargetPrivateSubnet${Az}:
        Type: AWS::EFS::MountTarget
        Properties:
          FileSystemId: !Ref EfsFileSystem
          SecurityGroups: 
            - !GetAtt EfsSecurityGroup.GroupId
          SubnetId:
            Ref: !Sub PrivateSubnet${Az}
  EfsSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security Group
      GroupName: efs-sg
      SecurityGroupIngress: 
        - FromPort: 2049
          ToPort: 2049
          IpProtocol: tcp
          CidrIp: !GetAtt Vpc.CidrBlock
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: efs-sg
  
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: GlacierRule
            Prefix: glacier
            Status: Enabled
            ExpirationInDays: 365
            Transitions:
              - TransitionInDays: 14
                StorageClass: GLACIER

  EksBackupVault:
    Type: AWS::Backup::BackupVault
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      BackupVaultName: eks
      Notifications: 
        BackupVaultEvents:
          - EKS_RESTORE_OBJECT_FAILED
          - EKS_RESTORE_OBJECT_SKIPPED
        SNSTopicArn: !GetAtt EksSnsTopic.TopicArn
  EksSnsTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription: 
        - Protocol: sqs
          Endpoint: !GetAtt EksQueue.Arn
  EksQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      MessageRetentionPeriod: 3600
  EksBackupIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - backup.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSBackupServiceRolePolicyForBackup
        - arn:aws:iam::aws:policy/service-role/AWSBackupServiceRolePolicyForRestores
        # https://docs.aws.amazon.com/ko_kr/aws-backup/latest/devguide/s3-backups.html#s3-backup-prerequisites
        - arn:aws:iam::aws:policy/AWSBackupServiceRolePolicyForS3Backup
        - arn:aws:iam::aws:policy/AWSBackupServiceRolePolicyForS3Restore

  SecondaryCluster:
    Type: AWS::EKS::Cluster
    Properties:
      Version: !Ref KubernetesVersion
      AccessConfig: 
        AuthenticationMode: API_AND_CONFIG_MAP
        BootstrapClusterCreatorAdminPermissions: true
      BootstrapSelfManagedAddons: false
      Logging: 
        ClusterLogging: 
          EnabledTypes: 
            - Type: api
            - Type: audit
            - Type: authenticator
            - Type: controllerManager
            - Type: scheduler
      ResourcesVpcConfig: 
        EndpointPrivateAccess: true
        EndpointPublicAccess: true
        SubnetIds: 
          - !Ref PublicSubneta
          - !Ref PublicSubnetc
          - !Ref PrivateSubneta
          - !Ref PrivateSubnetc
      RoleArn: !GetAtt EksClusterIamRole.Arn
      KubernetesNetworkConfig:
        IpFamily: ipv4
        ServiceIpv4Cidr: 172.20.0.0/16
  SecondaryClusterOidcProvider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      Url: !GetAtt SecondaryCluster.OpenIdConnectIssuerUrl
      ClientIdList: 
        - sts.amazonaws.com

  SsmAssociation:
    Type: AWS::SSM::Association
    DependsOn:
      - VsCodeEc2 # Required
    Properties:
      Name: AWS-RunShellScript
      WaitForSuccessTimeoutSeconds: 600
      Targets:
        - Key: InstanceIds
          Values:
            - !Ref VsCodeEc2
      Parameters:
        commands: 
          # uid=0(root) gid=0(root) groups=0(root) context=system_u:system_r:unconfined_service_t:s0
          - !Sub |
              sleep 180

              su - ec2-user << 'SSMEOF'
              export HOME=/home/ec2-user
              cd $HOME
              aws backup start-backup-job --backup-vault-name ${EksBackupVault} --resource-arn ${PrimaryCluster.Arn} --iam-role-arn ${EksBackupIamRole.Arn}

              cat << 'EOF' >> /home/ec2-user/README.md
              # EKS Backup / Restore
              
              Backup
              ```
              aws backup start-backup-job \
              --backup-vault-name ${EksBackupVault} \
              --resource-arn ${PrimaryCluster.Arn} \
              --iam-role-arn ${EksBackupIamRole.Arn}
              ```

              Composite Recovery Points
              ```
              aws backup list-recovery-points-by-resource \
              --resource-arn ${PrimaryCluster.Arn} \
              --query "RecoveryPoints[*].RecoveryPointArn" | grep composite:eks
              ```

              Existing Cluster Restore
              ```
              aws backup start-restore-job \
              --recovery-point-arn "⚠️" \
              --iam-role-arn ${EksBackupIamRole.Arn} \
              --metadata '⚠️' \
              --resource-type "EKS"
              ```

              New Cluster Restore
              ```
              aws backup start-restore-job \
              --recovery-point-arn "⚠️" \
              --iam-role-arn ${EksBackupIamRole.Arn} \
              --metadata '⚠️' \
              --resource-type "EKS"

              IAM Accss Entry - Access Policy
              ```
              aws eks create-access-entry --type STANDARD \
              --cluster-name ${SecondaryCluster} \
              --principal-arn ${EksBackupIamRole.Arn}

              aws eks associate-access-policy --access-scope type=cluster \
              --cluster-name ${SecondaryCluster} \
              --principal-arn ${EksBackupIamRole.Arn} \
              --policy-arn arn:aws:eks::aws:cluster-access-policy/AWSBackupFullAccessPolicyForRestore
              ```
              EOF

              SSMEOF

Outputs:
  VsCode:
    Value: !Sub http://${VsCodeEc2.PublicIp}:8000
    Description: Public IP Address of the VS Code